<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>拉霸機：顯示最上方且離中心最近的捲軸</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
    <style>
      body { background: #222; color: #fff; margin: 0; }
      #game-container { float: left; }
      #reward-box {
        position: absolute;
        left: 820px; top: 10px;
        width: 200px; height: 580px;
        border: 1px solid #999;
        background: #222; color: #fff;
        overflow-y: auto; padding: 10px;
      }
      #bet-container {
        position: absolute; left:10px; top:620px;
        color: #fff;
      }
      #betInput { width:80px; }
      #homeBtn {
        position: absolute;
        top:620px; left:200px;
        color:#fff; background:#444;
        padding:6px 12px; border:1px solid #666;
        border-radius:4px; text-decoration: none;
      }
    </style>
  </head>
  <body>
    <div id="game-container"></div>
    <div id="reward-box">
      <h3>獎勵紀錄</h3>
      <div id="reward-logs">尚無紀錄</div>
    </div>
    <div id="bet-container">
      <label for="betInput">BET:</label>
      <input type="number" id="betInput" value="10" min="1" max="9999" step="1">
    </div>
    <!-- 回首頁按鈕 -->
    <a id="homeBtn" href="/members/home">回會員首頁</a>

    <!-- Django 變數 -->
    <script>
      let userId = {{ user_id|default:0 }};
      let currentPoints = {{ points|default:0 }};
    </script>

    <script>
      // Phaser 設定
      const config = {
        type: Phaser.AUTO,
        width: 800,
        height: 600,
        parent: 'game-container',
        scene: { preload, create, update }
      };
      const game = new Phaser.Game(config);

      let reelContainers = [];
      let spinning = false;
      let autoSpinCount = 0;

      // 三秒 => 前1秒(Phase1),後2秒(Phase2)
      const PHASE1_DURATION = 1000;
      const PHASE2_DURATION = 2000;

      function preload(){
        // 載入外框
        this.load.image("machineFrame", "/static/casino/slot_frame.png");
        // 符號
        this.load.image("symbol1", "/static/casino/symbol1.png");
        this.load.image("symbol2", "/static/casino/symbol2.png");
        this.load.image("symbol3", "/static/casino/symbol3.png");
        this.load.image("symbol4", "/static/casino/symbol4.png");
        this.load.image("wild",    "/static/casino/wild.png");
      }

      function create(){
        const scene=this;

        // 1) 建立3個容器
        let reelPositions=[
          { x:400-145, y:290 },
          { x:400,     y:290 },
          { x:400+145, y:290 }
        ];
        reelPositions.forEach(pos=>{
          let c=scene.add.container(pos.x,pos.y);
          for(let i=0;i<3;i++){
            let spr=scene.add.sprite(0,(i-1)*80, pickRandomSymbol());
            c.add(spr);
          }
          reelContainers.push(c);
        });

        // 2) 外框
        scene.add.image(400,300,"machineFrame").setScale(2).setDepth(10);

        // 3) Mask
        let maskRect=scene.add.rectangle(400,300,440,180,0x00ff00,0).setDepth(15);
        let reelMask=maskRect.createGeometryMask();
        reelContainers.forEach(c=> c.setMask(reelMask));

        // 4) Points
        scene.pointText=scene.add.text(10,10, `Points: ${currentPoints}`, {
          fontSize:'24px', color:'#FFD700'
        });

        // 5) SPIN
        let spinBtn= scene.add.text(400,500,"SPIN",{
          fontSize:'32px', backgroundColor:'#cc0000', color:'#fff',padding:{x:20,y:10}
        }).setOrigin(0.5).setInteractive();
        spinBtn.on('pointerdown', ()=>{
          if(!spinning){
            let betAmount=getBetValue();
            startSpinAPI(scene, userId, betAmount);
          }
        });

        // 6) 自動轉
        scene.add.text(600,480,"自動轉:", {fontSize:'20px',color:'#fff'}).setDepth(20);
        let autoOpts=[30,50,100];
        autoOpts.forEach((opt,i)=>{
          let autoBtn=scene.add.text(600, 500+i*25, `${opt}次`,{
            fontSize:'18px',backgroundColor:'#555',color:'#fff',padding:{x:5,y:2}
          }).setInteractive().setDepth(20);
          autoBtn.on('pointerdown',()=>{
            if(!spinning&&autoSpinCount===0){
              let betAmount=getBetValue();
              autoSpinCount=opt;
              startSpinAPI(scene, userId, betAmount);
            }
          });
        });
      }

      function update(){}

      // 抓 BET 數字
      function getBetValue(){
        let betInput=document.getElementById("betInput");
        let val=parseInt(betInput.value,10)||10;
        return val;
      }

      // 呼叫後端
      function startSpinAPI(scene, userId, bet){
        spinning=true;
        fetch("/casino/slot/spin/", {
          method:"POST",
          headers:{"Content-Type":"application/x-www-form-urlencoded"},
          body:new URLSearchParams({
            user_id: userId,
            bet: bet
          })
        })
        .then(r=>r.json())
        .then(data=>{
          if(data.error){
            alert(data.error);
            spinning=false; autoSpinCount=0;
            return;
          }
          spinReelsSequentially(scene, data.reels, data.win_amount, data.current_points, bet);
        })
        .catch(err=>{
          console.error("API Error:", err);
          spinning=false; autoSpinCount=0;
        });
      }

      // 依序轉動
      function spinReelsSequentially(scene, reelResults, win, newPoints, usedBet){
        let index=0;
        function spinNext(){
          if(index>=reelContainers.length){
            spinning=false;
            currentPoints=newPoints;
            scene.pointText.setText(`Points: ${currentPoints}`);
            if(win>0) addRewardLog(`贏了 ${win} 點 (BET=${usedBet})`);
            if(autoSpinCount>0){
              autoSpinCount--;
              if(autoSpinCount>0){
                startSpinAPI(scene, userId, usedBet);
              }
            }
            return;
          }
          doPhase1(scene, reelContainers[index], PHASE1_DURATION, ()=>{
            doPhase2(scene, reelContainers[index], reelResults[index], PHASE2_DURATION, ()=>{
              index++;
              spinNext();
            });
          });
        }
        spinNext();
      }

      // Phase1: 前1秒固定速度+隨機
      function doPhase1(scene, container, duration, onComplete){
        let startTime=scene.time.now;
        let speed=25;

        let phase1Event= scene.time.addEvent({
          delay:40, loop:true,
          callback:()=>{
            let elapsed=scene.time.now - startTime;
            if(elapsed>=duration){
              phase1Event.remove();
              if(onComplete) onComplete();
              return;
            }
            // 固定速度+隨機
            container.list.forEach(spr=>{
              spr.y+=speed;
              if(spr.y>80){
                spr.y-=240;
                spr.setTexture(pickRandomSymbol());
              }
            });
          }
        });
      }

      // Phase2: 後2秒漸減速, 不換圖 => 最終 "上方且離中心最近" sprite
      function doPhase2(scene, container, finalKey, duration, onComplete){
        let startTime= scene.time.now;
        let baseSpeed=25;
        let phase2Event= scene.time.addEvent({
          delay:40, loop:true,
          callback:()=>{
            let elapsed= scene.time.now - startTime;
            let ratio= elapsed/duration;
            let curSpeed= baseSpeed*(1-ratio);
            if(curSpeed<2) curSpeed=2;

            // 只移動 不換圖
            container.list.forEach(spr=>{
              spr.y+=curSpeed;
              if(spr.y>80){
                spr.y-=240;
              }
            });

            if(elapsed>=duration){
              phase2Event.remove();
              // 找最上方但距 y=0 最近
              let topSpr=findUpperClosestToCenter(container);
              let offset=topSpr.y;
              container.list.forEach(s=> s.y-=offset);
              // topSpr 換最終符號
              topSpr.setTexture(finalKey);

              if(onComplete) onComplete();
            }
          }
        });
      }

      // 挑隨機符號
      function pickRandomSymbol(){
        let syms=["symbol1","symbol2","symbol3","symbol4","wild"];
        return Phaser.Utils.Array.GetRandom(syms);
      }

      // 找最上方 但最接近 y=0 的 sprite
      function findUpperClosestToCenter(container){
        let bestSpr=null, bestDist= Infinity;
        // 只考慮 y <= 0
        container.list.forEach(spr=>{
          if(spr.y <= 0){
            let dist=Math.abs(spr.y);
            if(dist<bestDist){
              bestDist=dist;
              bestSpr=spr;
            }
          }
        });
        // 若全都 y>0, 則退而求最近
        if(!bestSpr){
          bestSpr = findClosestToZero(container);
        }
        return bestSpr;
      }

      // 若上面都沒有 => 取最接近 y=0
      function findClosestToZero(container){
        let target=null, minDist=99999;
        container.list.forEach(s=>{
          let d=Math.abs(s.y);
          if(d<minDist){
            minDist=d; target=s;
          }
        });
        return target;
      }

      // 獎勵紀錄
      function addRewardLog(text){
        let logDiv=document.getElementById("reward-logs");
        if(!logDiv)return;
        if(logDiv.innerHTML==="尚無紀錄") logDiv.innerHTML="";
        let now=new Date();
        let line=`[${now.toLocaleTimeString()}] ${text}`;
        logDiv.innerHTML+= line+"<br/>";
        logDiv.scrollTop= logDiv.scrollHeight;
      }
    </script>
  </body>
</html>
