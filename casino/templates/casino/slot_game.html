<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>拉霸機 </title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
    <style>
      body { background:#222; color:#fff; margin:0; }
      #game-container { float:left; }
      /* 你也可加入右側獎勵紀錄框 / BET輸入 / 回首頁按鈕等 DOM */
    </style>
  </head>
  <body>
    <div id="game-container"></div>

    <!-- Django 注入的 userId, points -->
    <script>
      let userId = {{ user_id|default:0 }};
      let currentPoints = {{ points|default:0 }};
    </script>

    <script>
      const config = {
        type: Phaser.AUTO,
        width: 800,
        height: 600,
        parent: 'game-container',
        scene: { preload, create, update }
      };
      const game = new Phaser.Game(config);

      let reelContainers = [];
      let spinning = false;
      let reelSequences = []; // from backend

      // 兩段式: Phase1=1秒 => Phase2=2秒
      const PHASE1_DURATION=1000;
      const PHASE2_DURATION=2000;

      function preload(){
        this.load.image("machineFrame","/static/casino/slot_frame.png");
        this.load.image("symbol1","/static/casino/symbol1.png");
        this.load.image("symbol2","/static/casino/symbol2.png");
        this.load.image("symbol3","/static/casino/symbol3.png");
        this.load.image("symbol4","/static/casino/symbol4.png");
        this.load.image("wild",   "/static/casino/wild.png");
      }

      function create(){
        const scene=this;
        // 建 3 個容器(3 個 sprite each)
        let reelPos= [ {x:255,y:290}, {x:400,y:290}, {x:545,y:290} ];
        reelPos.forEach(pos=>{
          let c= scene.add.container(pos.x, pos.y);
          for(let i=0;i<3;i++){
            let spr= scene.add.sprite(0,(i-1)*80,"symbol1");
            c.add(spr);
          }
          reelContainers.push(c);
        });

        // 外框
        scene.add.image(400,300,"machineFrame").setScale(2);

        // 分數
        scene.add.text(10,10,`Points:${currentPoints}`,{
          fontSize:'24px', color:'#FFD700'
        });

        // Spin 按鈕
        let spinBtn= scene.add.text(400,500,"SPIN",{
          fontSize:'32px', backgroundColor:'#cc0000', color:'#fff', padding:{x:20,y:10}
        }).setOrigin(0.5).setInteractive();

        spinBtn.on('pointerdown', ()=>{
          if(!spinning){
            startSpinAPI(scene, userId, 10);
          }
        });
      }

      function update(){}

      function startSpinAPI(scene, userId, bet){
        spinning=true;
        fetch("/casino/slot/spin/", {
          method:"POST",
          headers:{"Content-Type":"application/x-www-form-urlencoded"},
          body: new URLSearchParams({ user_id:userId, bet:bet })
        })
        .then(r=>r.json())
        .then(data=>{
          if(data.error){
            alert(data.error); 
            spinning=false;
            return;
          }
          // reelSequences => e.g. [ seq1, seq2, seq3 ]
          // each seq = 12 符號
          reelSequences = data.reelSequences;

          // do Phase1, Phase2
          doPhase1(scene, PHASE1_DURATION, ()=>{
            doPhase2(scene, PHASE2_DURATION, ()=>{
              spinning=false;
              // update points
              currentPoints= data.current_points;
              // show win if needed
            });
          });
        })
        .catch(err=>{
          console.error("API Error:",err);
          spinning=false;
        });
      }

      // Phase1: 1秒,固定速度 + 不斷 shift() 取 seq
      function doPhase1(scene, duration, onComplete){
        let startTime= scene.time.now;
        let speed=25;

        let phase1Event= scene.time.addEvent({
          delay:40,
          loop:true,
          callback:()=>{
            let elapsed= scene.time.now - startTime;
            if(elapsed>= duration){
              phase1Event.remove();
              if(onComplete) onComplete();
              return;
            }
            // 移動 + 取 nextSym
            reelContainers.forEach( (container, i)=>{
              container.list.forEach(spr=>{
                spr.y += speed;
                if(spr.y>80){
                  spr.y-=240;
                  // ★ 從 reelSequences[i] 取下一個符號
                  if(reelSequences[i].length>0){
                    let nextSym = reelSequences[i].shift();
                    spr.setTexture(nextSym);
                  }
                }
              });
            });
          }
        });
      }

      // Phase2: 2秒,漸減速 + 不再 shift
      function doPhase2(scene, duration, onComplete){
        let startTime= scene.time.now;
        let baseSpeed=25;
        let phase2Event= scene.time.addEvent({
          delay:40,
          loop:true,
          callback:()=>{
            let elapsed= scene.time.now - startTime;
            if(elapsed>= duration){
              phase2Event.remove();
              if(onComplete) onComplete();
              return;
            }
            let ratio= elapsed/duration;
            let curSpeed= baseSpeed*(1-ratio);
            if(curSpeed<2) curSpeed=2;

            reelContainers.forEach(container=>{
              container.list.forEach(spr=>{
                spr.y += curSpeed;
                if(spr.y>80){
                  spr.y-=240;
                  // 不再 shift => 保持最終符號
                }
              });
            });
          }
        });
      }

      // (若需要) pickRandomSymbol, 這裡用不上了
      // function pickRandomSymbol(){ ... }
    </script>
  </body>
</html>
