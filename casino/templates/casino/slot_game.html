<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>拉霸機 Demo：二段式轉動，前段隨機+後段漸停不換圖</title>
    <!-- 引入 Phaser 3 -->
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
    <style>
      /* 獎勵紀錄框 */
      #reward-box {
        position: absolute;
        left: 820px;
        top: 10px;
        width: 200px;
        height: 580px;
        border: 1px solid #999;
        background: #222;
        color: #fff;
        overflow-y: auto;
        padding: 10px;
      }
      #reward-box h3 {
        margin: 5px 0;
      }
    </style>
  </head>
  <body style="background: #222; color: #fff; margin:0;">
    <div id="game-container"></div>
    <div id="reward-box">
      <h3>獎勵紀錄</h3>
      <div id="reward-logs">尚無紀錄</div>
    </div>

    <!-- Django 模板變數：user_id, points -->
    <script>
      let userId = {{ user_id|default:0 }};
      let currentPoints = {{ points|default:0 }};
    </script>

    <script>
      const config = {
        type: Phaser.AUTO,
        width: 800,
        height: 600,
        parent: 'game-container',
        scene: { preload, create, update }
      };
      const game = new Phaser.Game(config);

      let reelContainers = [];
      let spinning = false;
      let autoSpinCount = 0;
      let betAmount = 10;

      function preload(){
        // 載入外框
        this.load.image("machineFrame", "/static/casino/slot_frame.png");
        // 符號
        this.load.image("symbol1", "/static/casino/symbol1.png");
        this.load.image("symbol2", "/static/casino/symbol2.png");
        this.load.image("symbol3", "/static/casino/symbol3.png");
        this.load.image("symbol4", "/static/casino/slot_frame.png");
        this.load.image("wild",    "/static/casino/wild.png");

        // 請注意 symbol4 是否誤綁定 "/static/casino/slot_frame.png"？
        // 如果這是錯誤路徑，請自行改正
      }

      function create(){
        const scene = this;

        // 1) 建立 3 個容器(3行符號)
        let reelPositions = [
          { x: 400-145, y: 290 },
          { x: 400,     y: 290 },
          { x: 400+145, y: 290 }
        ];
        reelPositions.forEach(pos=>{
          let c = scene.add.container(pos.x, pos.y);
          // 上/中/下
          for(let i=0; i<3; i++){
            let spr = scene.add.sprite(0, (i-1)*80, pickRandomSymbol());
            c.add(spr);
          }
          reelContainers.push(c);
        });

        // 2) 外框
        scene.add.image(400, 300, "machineFrame").setScale(2).setDepth(10);

        // 3) Mask
        let maskRect = scene.add.rectangle(400,300,440,180,0x00ff00,0).setDepth(15);
        let reelMask = maskRect.createGeometryMask();
        reelContainers.forEach(c => c.setMask(reelMask));

        // 4) 分數
        scene.pointText = scene.add.text(10,10, `Points: ${currentPoints}`,{
          fontSize:'24px', color:'#FFD700'
        });

        // 5) BET
        scene.betText = scene.add.text(300,560, `BET: ${betAmount}`, {
          fontSize:'20px', color:'#fff'
        });
        scene.betText.setInteractive().on('pointerdown', ()=>{
          betAmount += 10;
          if(betAmount>100) betAmount=10;
          scene.betText.setText(`BET: ${betAmount}`);
        });

        // 6) SPIN
        let spinBtn = scene.add.text(400,500, "SPIN", {
          fontSize:'32px', backgroundColor:'#cc0000', color:'#fff', padding:{x:20,y:10}
        }).setOrigin(0.5).setInteractive();
        spinBtn.on('pointerdown', ()=>{
          if(!spinning){
            startSpinAPI(scene, userId, betAmount);
          }
        });

        // 7) 自動轉
        scene.add.text(600,480,"自動轉:", {fontSize:'20px',color:'#fff'}).setDepth(20);
        let autoOpts=[30,50,100];
        autoOpts.forEach((opt,i)=>{
          let autoBtn = scene.add.text(600, 500+i*25, `${opt}次`, {
            fontSize:'18px', backgroundColor:'#555',color:'#fff',padding:{x:5,y:2}
          }).setInteractive().setDepth(20);
          autoBtn.on('pointerdown', ()=>{
            if(!spinning && autoSpinCount===0){
              autoSpinCount=opt;
              startSpinAPI(scene, userId, betAmount);
            }
          });
        });
      }

      function update(){}

      // --------------------------------------------------------------------------------------
      // 呼叫後端
      // --------------------------------------------------------------------------------------
      function startSpinAPI(scene, userId, bet){
        spinning=true;
        fetch("/casino/slot/spin/", {
          method:"POST",
          headers:{"Content-Type":"application/x-www-form-urlencoded"},
          body:new URLSearchParams({
            user_id: userId,
            bet: bet
          })
        })
        .then(r=>r.json())
        .then(data=>{
          if(data.error){
            alert(data.error);
            spinning=false;
            autoSpinCount=0;
            return;
          }
          spinReelsSequentially(scene, data.reels, data.win_amount, data.current_points, bet);
        })
        .catch(err=>{
          console.error("API Error:", err);
          spinning=false; autoSpinCount=0;
        });
      }

      // --------------------------------------------------------------------------------------
      // 依序轉動捲軸：三個捲軸 => 先做 Phase1(固定速度+隨機) 再做 Phase2(漸減速不換圖)
      // --------------------------------------------------------------------------------------
      function spinReelsSequentially(scene, reelResults, win, newPoints, usedBet){
        let index=0;
        function spinNext(){
          if(index>=reelContainers.length){
            // 全部完成
            spinning=false;
            currentPoints=newPoints;
            scene.pointText.setText(`Points: ${currentPoints}`);
            if(win>0) addRewardLog(`贏了 ${win} 點 (BET=${usedBet})`);
            // 自動轉
            if(autoSpinCount>0){
              autoSpinCount--;
              if(autoSpinCount>0){
                startSpinAPI(scene, userId, usedBet);
              }
            }
            return;
          }
          // 先 Phase1, 再 Phase2
          doPhase1(scene, reelContainers[index], ()=>{
            doPhase2(scene, reelContainers[index], reelResults[index], ()=>{
              index++;
              spinNext();
            });
          });
        }
        spinNext();
      }

      // --------------------------------------------------------------------------------------
      // Phase1: 固定速度 + 隨機換圖
      // --------------------------------------------------------------------------------------
      // 例如 0.8秒
      function doPhase1(scene, container, onComplete){
        let startTime = scene.time.now;
        let duration = 800; // 可自行調整
        let speed=25; // 固定速度

        let phase1Event = scene.time.addEvent({
          delay: 40,
          loop: true,
          callback: () => {
            let elapsed = scene.time.now - startTime;
            if(elapsed >= duration){
              phase1Event.remove();
              if(onComplete) onComplete();
              return;
            }
            // 不斷向下移
            container.list.forEach(spr=>{
              spr.y += speed;
              if(spr.y>80){
                spr.y-=240;
                spr.setTexture(pickRandomSymbol());
              }
            });
          }
        });
      }

      // --------------------------------------------------------------------------------------
      // Phase2: 漸減速，不再換圖 => 最後對準
      // --------------------------------------------------------------------------------------
      // 例如 1.4秒
      function doPhase2(scene, container, finalKey, onComplete){
        let startTime = scene.time.now;
        let duration = 1400;
        let baseSpeed=25; // 從25逐漸降到2

        let phase2Event = scene.time.addEvent({
          delay:40,
          loop:true,
          callback:()=>{
            let elapsed = scene.time.now - startTime;
            let ratio= elapsed/duration;
            let currentSpeed = baseSpeed*(1-ratio);
            if(currentSpeed<2) currentSpeed=2;

            container.list.forEach(spr=>{
              spr.y += currentSpeed;
              // 不換圖，只移動
              if(spr.y>80){
                spr.y-=240;
                // 不換圖
              }
            });

            if(elapsed>=duration){
              phase2Event.remove();
              // 校正 => 中間 sprite y=0
              let midSpr=findClosestToZero(container);
              let offset= midSpr.y;
              container.list.forEach(s=> s.y-=offset);
              // 用最終結果
              midSpr.setTexture(finalKey);
              if(onComplete) onComplete();
            }
          }
        });
      }

      // --------------------------------------------------------------------------------------
      // 輔助函式
      // --------------------------------------------------------------------------------------
      function pickRandomSymbol(){
        let symbols = ["symbol1","symbol2","symbol3","symbol4","wild"];
        return Phaser.Utils.Array.GetRandom(symbols);
      }

      function findClosestToZero(container){
        let minDist=99999, target=null;
        container.list.forEach(s=>{
          let d=Math.abs(s.y);
          if(d<minDist){
            minDist=d; target=s;
          }
        });
        return target;
      }

      function addRewardLog(text){
        let logDiv=document.getElementById("reward-logs");
        if(!logDiv)return;
        if(logDiv.innerHTML==="尚無紀錄") logDiv.innerHTML="";
        let now=new Date();
        let line=`[${now.toLocaleTimeString()}] ${text}`;
        logDiv.innerHTML += line+"<br/>";
        logDiv.scrollTop = logDiv.scrollHeight;
      }
    </script>
  </body>
</html>
