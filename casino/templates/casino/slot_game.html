<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>拉霸機 Demo (改良版)</title>
    <!-- 引入 Phaser 3 -->
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
  </head>
  <body style="background: #222; color: #fff; margin:0;">
    <div id="game-container"></div>

    <!-- Django 模板變數：user_id, points -->
    <script>
      let userId = {{ user_id|default:0 }};
      let currentPoints = {{ points|default:0 }};
    </script>

    <script>
      // Phaser 設定
      const config = {
        type: Phaser.AUTO,
        width: 800,
        height: 600,
        parent: 'game-container',
        scene: {
          preload: preload,
          create: create,
          update: update
        }
      };
      const game = new Phaser.Game(config);

      // 全域變數：每個捲軸是一個容器
      let reelContainers = [];
      let spinning = false;

      function preload() {
        // 載入外框圖 (229×102 放大兩倍)
        this.load.image("machineFrame", "/static/casino/slot_frame.png");
        // 載入符號
        this.load.image("symbol1", "/static/casino/symbol1.png");
        this.load.image("symbol2", "/static/casino/symbol2.png");
        this.load.image("symbol3", "/static/casino/symbol3.png");
        this.load.image("symbol4", "/static/casino/symbol4.png");
        this.load.image("wild", "/static/casino/wild.png");
      }

      function create() {
        const scene = this;

        // 加入拉霸機外框
        const frame = scene.add.image(400, 300, "machineFrame").setScale(2);

        // 建立三個捲軸容器，x 根據你給的位置
        const reelPositions = [
          { x: 400 - 145, y: 300 - 42 },
          { x: 400, y: 300 - 42 },
          { x: 400 + 145, y: 300 - 42 }
        ];

        reelPositions.forEach(pos => {
          let reelContainer = scene.add.container(pos.x, pos.y);
          reelContainers.push(reelContainer);

          // 每個容器初始放一個隨機符號
          let symbol = scene.add.sprite(0, 0, Phaser.Utils.Array.GetRandom(["symbol1", "symbol2", "symbol3", "symbol4", "wild"]));
          reelContainer.add(symbol);
        });

        // 顯示當前積分
        scene.pointText = scene.add.text(10, 10, `Points: ${currentPoints}`, { fontSize: '24px', color: '#FFD700' });

        // Spin 按鈕
        const spinButton = scene.add.text(400, 500, "SPIN", { fontSize: '32px', backgroundColor: '#cc0000', color: '#fff', padding: { x: 20, y: 10 } })
          .setInteractive()
          .setOrigin(0.5);

        spinButton.on('pointerdown', function () {
          if (!spinning) {
            startSpinAPI(scene, userId, 10);
          }
        });
      }

      function update() {
        // 暫無更新需要
      }

      function startSpinAPI(scene, userId, bet) {
        spinning = true;
        fetch("/casino/slot/spin/", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: new URLSearchParams({ user_id: userId, bet: bet })
        })
        .then(res => res.json())
        .then(data => {
          if (data.error) {
            alert(data.error);
            spinning = false;
            return;
          }
          spinAllReels(scene, data.reels, data.win_amount, data.current_points);
        })
        .catch(err => {
          console.error("API Error:", err);
          spinning = false;
        });
      }

      function spinAllReels(scene, reelResults, win, newPoints) {
        let spinsComplete = 0;

        reelContainers.forEach((container, index) => {
          let symbol = container.list[0];  // 容器中的第一個元素（我們的符號）
          let startY = symbol.y;

          // 使用 tween 創造上下晃動效果
          scene.tweens.add({
            targets: symbol,
            y: startY + 20,  // 上下移動 20px
            duration: 100,
            yoyo: true,
            repeat: 10,  // 來回重複次數
            onComplete: function () {
              // 設置最終圖像
              symbol.setTexture(reelResults[index]);
              // 確認所有捲軸完成旋轉
              spinsComplete++;
              if (spinsComplete === reelContainers.length) {
                spinning = false;
                currentPoints = newPoints;
                scene.pointText.setText(`Points: ${currentPoints}`);
                if (win > 0) {
                  alert(`恭喜贏了 ${win} 點!`);
                }
              }
            }
          });
        });
      }
    </script>
  </body>
</html>
