<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>拉霸機 Demo：方案A + 遮罩上方 + 調高20px</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
    <style>
      body {
        margin: 0; 
        background: #222; 
        color: #fff;
      }
      /* Phaser 遊戲區 */
      #game-container {
        float: left;
      }
      /* 獎勵紀錄框 - 右側 */
      #reward-box {
        position: absolute;
        left: 820px; /* 遊戲寬800 + 20px */
        top: 10px;
        width: 200px;
        height: 580px;
        border: 1px solid #999;
        background: #222;
        color: #fff;
        overflow-y: auto;
        padding: 10px;
      }
      #reward-box h3 {
        margin: 5px 0;
      }
      /* 下方 BET & 自動轉 & 回首頁 */
      #footer-controls {
        position: absolute;
        top: 620px;
        left: 10px;
        color: #fff;
      }
      #betInput {
        width: 80px;
      }
      .auto-btn {
        background: #555;
        color: #fff;
        padding: 5px 10px;
        margin-left: 5px;
        cursor: pointer;
      }
      #homeBtn {
        position: absolute;
        top: 620px;
        left: 500px;
        padding: 5px 10px;
        background: #444;
        color: #fff;
        text-decoration: none;
        border: 1px solid #666;
        border-radius: 4px;
      }
    </style>
  </head>
  <body>
    <div id="game-container"></div>

    <!-- 右側紀錄框 -->
    <div id="reward-box">
      <h3>獎勵紀錄</h3>
      <div id="reward-logs">尚無紀錄</div>
    </div>

    <!-- 下方控制區：BET / 自動轉 / 回首頁 -->
    <div id="footer-controls">
      <label for="betInput">BET:</label>
      <input type="number" id="betInput" value="10" min="1" max="9999" step="1">

      <span style="margin-left:20px;">自動轉:</span>
      <button class="auto-btn" data-times="30">30次</button>
      <button class="auto-btn" data-times="50">50次</button>
      <button class="auto-btn" data-times="100">100次</button>
    </div>

    <a id="homeBtn" href="/members/home">回會員首頁</a>

    <!-- Django 注入 userId, points -->
    <script>
      let userId = {{ user_id|default:0 }};
      let currentPoints = {{ points|default:0 }};
    </script>

    <script>
      // Phaser 設定
      const config = {
        type: Phaser.AUTO,
        width: 800,
        height: 600,
        parent: "game-container",
        scene: { preload, create, update }
      };
      const game = new Phaser.Game(config);

      let reelContainers = [];
      let spinning = false;
      let reelSequences = []; // 後端給的 3 條序列
      let autoSpinCount = 0;

      // Phase1=1秒, Phase2=2秒
      const PHASE1_DURATION=1000;
      const PHASE2_DURATION=2000;

      function preload(){
        this.load.image("machineFrame","/static/casino/slot_frame.png");
        this.load.image("symbol1","/static/casino/symbol1.png");
        this.load.image("symbol2","/static/casino/symbol2.png");
        this.load.image("symbol3","/static/casino/symbol3.png");
        this.load.image("symbol4","/static/casino/symbol4.png");
        this.load.image("wild",   "/static/casino/wild.png");
      }

      function create(){
        const scene = this;

        // ====== 1) 建3個捲軸容器 (向上移動約20px) ======
        // 原本 y=300, 現在 y=280
        let reelPositions = [
          {x: 255, y: 295},
          {x: 400, y: 295},
          {x: 545, y: 295}
        ];
        reelPositions.forEach(pos => {
          let c = scene.add.container(pos.x, pos.y);
          for(let i=0; i<3; i++){
            // sprite 同樣 (i-1)*80
            let spr = scene.add.sprite(0, (i-1)*80, "symbol1");
            c.add(spr);
          }
          reelContainers.push(c);
        });

        // ====== 2) 外框 ======
        // 位置不變 => (400,300) scale(2)
        scene.add.image(400, 300, "machineFrame").setScale(2).setDepth(10);

        // ====== 3) Mask, 調整中心 y=280 + ??? ======
        // 原本 (400,300), 現在可上移 => (400, 280 + ???)
        // 若你要只顯示下方(不看上方), 讓中下部可見
        // 這裡試 (400,280+20=300), 依需求微調
        let maskRect = scene.add.rectangle(400, 300, 440, 196, 0x00ff00, 0);
        const reelMask = maskRect.createGeometryMask();
        reelContainers.forEach(c => c.setMask(reelMask));

        // ====== 4) 顯示 points ======
        scene.add.text(10, 10, `Points: ${currentPoints}`, {
          fontSize:'24px',
          color:'#FFD700'
        });

        // ====== 5) Spin 按鈕 ======
        let spinText = scene.add.text(400, 500, "SPIN", {
          fontSize:'32px', backgroundColor:'#cc0000', color:'#fff', padding:{x:20,y:10}
        }).setOrigin(0.5).setInteractive();

        spinText.on('pointerdown', () => {
          if(!spinning){
            let betVal = getBetValue();
            startSpinAPI(scene, userId, betVal);
          }
        });

        // ====== 6) 自動轉按鈕 ======
        let autoButtons = document.querySelectorAll(".auto-btn");
        autoButtons.forEach(btn => {
          btn.addEventListener("click", () => {
            if(!spinning && autoSpinCount===0){
              let times = parseInt(btn.dataset.times,10)||30;
              autoSpinCount = times;
              let betVal = getBetValue();
              startSpinAPI(scene, userId, betVal);
            }
          });
        });
      }

      function update(){}

      // 讀取下方 BET 輸入框
      function getBetValue(){
        let inp = document.getElementById("betInput");
        let val = parseInt(inp.value,10) || 10;
        return val;
      }

      function startSpinAPI(scene, userId, bet){
        spinning = true;
        fetch("/casino/slot/spin/", {
          method: "POST",
          headers: {"Content-Type":"application/x-www-form-urlencoded"},
          body: new URLSearchParams({ user_id:userId, bet:bet })
        })
        .then(r=>r.json())
        .then(data=>{
          if(data.error){
            alert(data.error);
            spinning=false; 
            autoSpinCount=0;
            return;
          }
          reelSequences = data.reelSequences; // 3 條序列(每條 12 個符號等)
          doPhase1(scene, PHASE1_DURATION, () => {
            doPhase2(scene, PHASE2_DURATION, () => {
              // 最終停下
              spinning=false;
              currentPoints = data.current_points;
              // 若中獎 => 紀錄
              if(data.win_amount>0){
                addRewardLog(`贏了 ${data.win_amount} 點 (BET=${bet})`);
              }
              // 若有自動轉
              if(autoSpinCount>0){
                autoSpinCount--;
                if(autoSpinCount>0){
                  startSpinAPI(scene, userId, bet);
                }
              }
            });
          });
        })
        .catch(err=>{
          console.error("API Error:",err);
          spinning=false;
          autoSpinCount=0;
        });
      }

      // ========== Phase1：1秒, 亂跳 => shift 符號 ==========
      function doPhase1(scene, duration, onComplete){
        let startTime = scene.time.now;
        let speed=25;
        let e = scene.time.addEvent({
          delay:40,
          loop:true,
          callback:()=>{
            let elapsed= scene.time.now - startTime;
            if(elapsed>=duration){
              e.remove();
              if(onComplete) onComplete();
              return;
            }
            reelContainers.forEach( (c,i)=>{
              c.list.forEach(spr=>{
                spr.y+= speed;
                if(spr.y>80){
                  spr.y-=240;
                  // 從 reelSequences[i] 拿下一個符號
                  if(reelSequences[i].length>0){
                    let nextSym = reelSequences[i].shift();
                    spr.setTexture(nextSym);
                  }
                }
              });
            });
          }
        });
      }

      // ========== Phase2：2秒, 漸減速 => 不再換圖 ==========
      function doPhase2(scene, duration, onComplete){
        let startTime= scene.time.now;
        let baseSpeed=25;
        let e= scene.time.addEvent({
          delay:40,
          loop:true,
          callback:()=>{
            let elapsed= scene.time.now - startTime;
            if(elapsed>=duration){
              e.remove();
              if(onComplete) onComplete();
              return;
            }
            let ratio= elapsed/duration;
            let curSpeed= baseSpeed*(1-ratio);
            if(curSpeed<2) curSpeed=2;

            reelContainers.forEach(c=>{
              c.list.forEach(spr=>{
                spr.y += curSpeed;
                if(spr.y>80){
                  spr.y-=240;
                  // 不再換圖
                }
              });
            });
          }
        });
      }

      // 獎勵紀錄
      function addRewardLog(msg){
        const box= document.getElementById("reward-logs");
        if(!box)return;
        if(box.innerHTML==="尚無紀錄") box.innerHTML="";
        const now=new Date();
        const line=`[${now.toLocaleTimeString()}] ${msg}`;
        box.innerHTML += line+"<br/>";
        box.scrollTop= box.scrollHeight;
      }
    </script>
  </body>
</html>
