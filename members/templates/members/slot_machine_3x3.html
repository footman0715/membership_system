{% extends "base.html" %}
{% load static %}

{% block title %}3x3 拉霸機{% endblock %}

{% block content %}
<div class="slot-machine-container">
  <!-- 背景容器 -->
  <div class="machine-bg">
    <!-- 背景圖：請確保 slot_machine_blank.png 已放在 static/members/ 裡 -->
    <img 
      src="{% static 'members/slot_machine_blank.png' %}" 
      alt="slot machine" 
      class="machine-bg-img"
    >

    <!-- ★ 符號顯示區 (3x3) 對準圖中三個轉軸的位置 -->
    <div class="reels-area" id="reelsArea">
      <!-- 後端產生的最終結果，或假動畫中隨機符號，都會顯示在這裡 -->
    </div>

    <!-- ★ 操作與資訊區 -->
    <div class="slot-controls">
      <!-- 顯示剩餘積分 -->
      <div class="alert alert-info mb-2">
        剩餘積分：<strong>{{ available_points }}</strong>
      </div>

      <!-- 下注表單：輸入 bet 後觸發假動畫再提交 -->
      <form method="POST" id="slotForm" class="mb-2">
        {% csrf_token %}
        <label for="id_bet" style="font-weight:bold;">下注積分：</label>
        {{ form.bet }}
        <button type="submit" class="btn btn-danger btn-sm" id="spinBtn">拉霸！</button>
      </form>

      <!-- 返回會員資料 -->
      <a href="{% url 'profile' %}" class="btn btn-light btn-sm mb-2">返回會員資料</a>

      <!-- 若後端有傳訊息 (贏分/結果) -->
      {% if message %}
      <div class="alert alert-success" style="white-space: pre-wrap;">
        {{ message }}
      </div>
      {% endif %}
    </div>

    <!-- ★ 後端若有最終結果 (grid)，就藏在 data-final，JS 會讀取並顯示 -->
    {% if grid %}
      <div id="finalGrid" data-final='{{ grid|safe }}' style="display:none;"></div>
    {% else %}
      <div id="finalGrid" data-final='[]' style="display:none;"></div>
    {% endif %}
  </div>
</div>

<!-- JS：假動畫 + 顯示最終結果 -->
<script>
document.addEventListener("DOMContentLoaded", function() {
    const spinBtn = document.getElementById("spinBtn");
    const slotForm = document.getElementById("slotForm");
    const reelsArea = document.getElementById("reelsArea");
    const finalGridDiv = document.getElementById("finalGrid");

    // ★ 若按「拉霸！」 => 先播假動畫再提交表單
    slotForm.addEventListener("submit", function(e) {
        e.preventDefault();
        spinReels(() => {
            // 假動畫結束後再提交表單給後端，後端計算結果並回傳
            slotForm.submit();
        });
    });

    // 假動畫：隨機轉動 1.5 秒
    function spinReels(onFinish) {
        const symbolsPool = ["🍒","🍋","🔔","⭐","7"];
        const startTime = Date.now();
        const duration = 1500; // 1.5秒
        const timer = setInterval(() => {
            const now = Date.now();
            const elapsed = now - startTime;
            if (elapsed >= duration) {
                clearInterval(timer);
                onFinish();
            } else {
                // 轉動中：顯示隨機 3x3
                reelsArea.innerHTML = randomGridHtml(symbolsPool);
            }
        }, 100);
    }

    // 生成 3x3 隨機符號 HTML
    function randomGridHtml(pool) {
        let html = "";
        for (let r = 0; r < 3; r++) {
            html += "<div>";
            for (let c = 0; c < 3; c++) {
                const sym = pool[Math.floor(Math.random() * pool.length)];
                html += `<span class="slot-symbol">${sym}</span>`;
            }
            html += "</div>";
        }
        return html;
    }

    // ★ 若後端已產生最終結果 => 直接顯示它 (頁面載入後)
    const finalData = finalGridDiv.dataset.final;
    if (finalData) {
        try {
            const grid = JSON.parse(finalData.replace(/'/g, '"'));
            if (Array.isArray(grid) && grid.length === 3) {
                // 將最終 3x3 結果顯示在 reelsArea
                let finalHtml = "";
                for (const row of grid) {
                    finalHtml += "<div>";
                    for (const sym of row) {
                        finalHtml += `<span class="slot-symbol">${sym}</span>`;
                    }
                    finalHtml += "</div>";
                }
                reelsArea.innerHTML = finalHtml;
            }
        } catch (e) {
            console.error("parse final grid error:", e);
        }
    }
});
</script>
{% endblock content %}

{% block extra_style %}
<style>
/* 外層容器置中 */
.slot-machine-container {
  display: flex;
  justify-content: center;
  margin-top: 1rem;
}

/* 背景圖容器 */
.machine-bg {
  position: relative;
  width: 700px;   /* 依照 slot_machine_blank.png 的寬度調整 */
  height: 500px;  /* 依照 slot_machine_blank.png 的高度調整 */
}

/* 背景圖全滿 */
.machine-bg-img {
  width: 100%;
  height: 100%;
  object-fit: cover; /* 可改成 contain, fill 等 */
}

/* 符號顯示區：對準圖片中的三個轉軸 */
.reels-area {
  position: absolute;
  top: 100px;   /* 需自行微調 */
  left: 120px;  /* 需自行微調 */
  width: 460px; /* 3 個轉軸的總寬度 (可加減) */
  height: 220px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
}

/* 讓每一列 (3 個符號) 置中 */
.reels-area div {
  text-align: center;
}

/* 每個符號樣式 */
.slot-symbol {
  font-size: 2rem;
  margin: 0 0.4rem;
}

/* 操作與資訊區 (下注、積分、返回按鈕等) */
.slot-controls {
  position: absolute;
  top: 350px;  /* 依照你的圖片需求微調 */
  left: 40px;
  width: 200px;
  background: rgba(255,255,255,0.7);
  padding: 0.5rem;
  border-radius: 6px;
}
</style>
{% endblock extra_style %}
