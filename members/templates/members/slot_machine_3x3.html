{% extends "base.html" %}
{% block title %}3x3 æ‹‰éœ¸æ©Ÿ{% endblock %}

{% block content %}
<div class="slot-machine-container">
  <!-- æ©Ÿå°æœ¬é«”ï¼ˆç´…è‰²å€ï¼‰ -->
  <div class="machine-body">
    <!-- å·¦å´æ‰‹æŠŠ -->
    <div class="machine-handle">
      <div class="handle-bar"></div>
      <div class="handle-knob"></div>
    </div>

    <!-- ä¸­é–“è½‰è¼ªå€ -->
    <div class="reels-area">
      <!-- ä¸Šæ–¹æ¨™é¡Œ -->
      <h2 class="machine-title">3x3 æ‹‰éœ¸æ©Ÿ</h2>

      <!-- å‰©é¤˜ç©åˆ†ã€è¿”å›æŒ‰éˆ• -->
      <div class="d-flex justify-content-between align-items-center my-2 px-3">
        <div class="alert alert-info mb-0" style="flex:1;">
          å‰©é¤˜ç©åˆ†ï¼š<strong>{{ available_points }}</strong>
        </div>
        <a href="{% url 'profile' %}" class="btn btn-light ms-2">è¿”å›æœƒå“¡è³‡æ–™</a>
      </div>

      <!-- ä¸‹æ³¨è¡¨å–® -->
      <form method="POST" id="slotForm" class="p-3" style="max-width: 400px; margin:auto;">
        {% csrf_token %}
        <div class="mb-3 text-center">
            {{ form.bet.label_tag }}
            {{ form.bet }}
            <small class="form-text text-muted">è«‹è¼¸å…¥æƒ³ä¸‹æ³¨çš„ç©åˆ†</small>
        </div>
        <div class="text-center">
          <button type="submit" class="btn btn-danger btn-lg" id="spinBtn">æ‹‰éœ¸ï¼</button>
        </div>
      </form>

      {% if message %}
      <div class="alert alert-success mt-3 text-center" style="white-space: pre-wrap;">
          {{ message }}
      </div>
      {% endif %}

      <!-- è½‰å‹•çµæœé¡¯ç¤ºå€ -->
      <div id="slotResult" class="my-4 text-center">
        {% if grid %}
          <div id="finalGrid" data-final='{{ grid|safe }}'></div>
        {% else %}
          <div id="finalGrid" data-final='[]'></div>
        {% endif %}
        <div id="reelsArea" class="reels-display mt-3"></div>
      </div>
    </div><!-- reels-area -->

    <!-- å³å´è³ ç‡è¡¨ (paytable) -->
    <div class="machine-paytable">
      <h5 class="paytable-title">è³ ç‡è¡¨</h5>
      <ul class="paytable-list">
        <li><span>7 7 7</span> = <span>Ã—5</span></li>
        <li><span>â­ â­ â­</span> = <span>Ã—3</span></li>
        <li><span>ğŸ’ ğŸ’ ğŸ’</span> = <span>Ã—2</span></li>
        <li><span>ğŸ‹ ğŸ‹ ğŸ‹</span> = <span>Ã—2</span></li>
        <li><span>ğŸ”” ğŸ”” ğŸ””</span> = <span>Ã—2</span></li>
      </ul>
    </div>
  </div><!-- machine-body -->

  <!-- äººå½¢ + åº•åº§ (åƒ…è£é£¾ç”¨) -->
  <div class="machine-stand">
    <div class="stand-person"></div>
  </div>
</div>

<!-- åŸæœ‰å‡å‹•ç•« JS -->
<script>
document.addEventListener("DOMContentLoaded", function() {
    const spinBtn = document.getElementById("spinBtn");
    const slotForm = document.getElementById("slotForm");
    const reelsArea = document.getElementById("reelsArea");
    const finalGridDiv = document.getElementById("finalGrid");

    // é˜»æ­¢è¡¨å–®é è¨­æäº¤
    slotForm.addEventListener("submit", function(e) {
        e.preventDefault();
        spinReels(function() {
            slotForm.submit();
        });
    });

    // å‡å‹•ç•«ï¼šè½‰å‹• 1.5 ç§’
    function spinReels(onFinish) {
        let symbolsPool = ["ğŸ’","ğŸ‹","ğŸ””","â­","7"];
        let startTime = Date.now();
        let duration = 1500; // 1.5 ç§’
        let timer = setInterval(function() {
            let now = Date.now();
            let elapsed = now - startTime;
            if (elapsed >= duration) {
                clearInterval(timer);
                onFinish();
            } else {
                reelsArea.innerHTML = randomGridHtml(symbolsPool);
            }
        }, 100);
    }

    // ç”Ÿæˆéš¨æ©Ÿ 3x3 HTML
    function randomGridHtml(pool) {
        let html = "";
        for (let r = 0; r < 3; r++) {
            html += "<div>";
            for (let c = 0; c < 3; c++) {
                let sym = pool[Math.floor(Math.random()*pool.length)];
                html += `<span class="slot-symbol">${sym}</span>`;
            }
            html += "</div>";
        }
        return html;
    }

    // é¡¯ç¤ºå¾Œç«¯çš„æœ€çµ‚çµæœ
    let finalData = finalGridDiv.dataset.final;
    if (finalData) {
        try {
            let grid = JSON.parse(finalData.replace(/'/g, '"'));
            let html = "";
            for (let row of grid) {
                html += "<div>";
                for (let sym of row) {
                    html += `<span class="slot-symbol">${sym}</span>`;
                }
                html += "</div>";
            }
            reelsArea.innerHTML = html;
        } catch(e) {
            console.error("parse final grid error:", e);
        }
    }
});
</script>
{% endblock %}

{% block extra_style %}
<style>
/* æ•´å€‹é é¢çš„å®¹å™¨ï¼Œå«æ©Ÿå°+äººå½¢ */
.slot-machine-container {
  position: relative;
  width: 100%;
  min-height: 80vh;
  margin: 1rem auto;
  display: flex;
  flex-direction: column;
  align-items: center;
}

/* ç´…è‰²æ©Ÿå°å¤–è§€ */
.machine-body {
  background: #d21f26;
  border: 3px solid #900;
  border-radius: 10px;
  display: flex;
  align-items: center;
  padding: 1rem;
  position: relative;
}

/* å·¦å´æ‰‹æŠŠ */
.machine-handle {
  width: 40px;
  display: flex;
  flex-direction: column;
  align-items: center;
  margin-right: 1rem;
}
.handle-bar {
  width: 10px;
  height: 80px;
  background: #444;
  border-radius: 5px;
}
.handle-knob {
  width: 20px;
  height: 20px;
  background: #666;
  border-radius: 50%;
  margin-top: 10px;
}

/* ä¸­é–“è½‰è¼ªå€ */
.reels-area {
  background: #fff;
  border: 2px solid #ccc;
  border-radius: 8px;
  padding: 1rem;
  margin: 0 1rem;
  min-width: 400px;
}

/* æ¨™é¡Œ */
.machine-title {
  color: #fff;
  text-align: center;
  font-weight: bold;
  text-shadow: 1px 1px 2px #000;
}

/* å³å´è³ ç‡è¡¨ */
.machine-paytable {
  background: #f4f4f4;
  border: 2px solid #ccc;
  border-radius: 8px;
  padding: 1rem;
  min-width: 150px;
  text-align: center;
}
.paytable-title {
  margin-bottom: 1rem;
  font-weight: bold;
}
.paytable-list {
  list-style: none;
  padding: 0;
  margin: 0;
}
.paytable-list li {
  display: flex;
  justify-content: space-between;
  margin: 0.4rem 0;
  font-size: 0.9rem;
}

/* æ‹‰éœ¸æ©Ÿä¸‹æ–¹ï¼šæ©Ÿå°è…³è¸æ¿ + äººå½¢ */
.machine-stand {
  position: relative;
  width: 100%;
  height: 100px;
  margin-top: -10px;
  background: #555;
  border-top: 2px solid #000;
  display: flex;
  align-items: flex-start;
  justify-content: center;
}
.stand-person {
  width: 20px;
  height: 40px;
  background: orange;
  border-radius: 5px;
  position: relative;
  top: -20px;
}

/* slot-symbolï¼šè½‰è¼ªç¬¦è™Ÿå¤–è§€ */
.slot-symbol {
  font-size: 2rem;
  margin: 0 0.5rem;
}
</style>
{% endblock extra_style %}
