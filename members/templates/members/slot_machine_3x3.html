{% extends "base.html" %}
{% load static %}

{% block title %}3x3 æ‹‰éœ¸æ©Ÿ{% endblock %}

{% block content %}
<div class="slot-machine-container">
  <!-- èƒŒæ™¯å®¹å™¨ -->
  <div class="machine-bg">
    <!-- èƒŒæ™¯åœ–ï¼šè«‹ç¢ºä¿ slot_machine_blank.png å·²æ”¾åœ¨ static/members/ è£¡ -->
    <img 
      src="{% static 'members/slot_machine_blank.png' %}" 
      alt="slot machine" 
      class="machine-bg-img"
    >

    <!-- â˜… ç¬¦è™Ÿé¡¯ç¤ºå€ (3x3) å°æº–åœ–ä¸­ä¸‰å€‹è½‰è»¸çš„ä½ç½® -->
    <div class="reels-area" id="reelsArea">
      <!-- å¾Œç«¯ç”¢ç”Ÿçš„æœ€çµ‚çµæœï¼Œæˆ–å‡å‹•ç•«ä¸­éš¨æ©Ÿç¬¦è™Ÿï¼Œéƒ½æœƒé¡¯ç¤ºåœ¨é€™è£¡ -->
    </div>

    <!-- â˜… æ“ä½œèˆ‡è³‡è¨Šå€ -->
    <div class="slot-controls">
      <!-- é¡¯ç¤ºå‰©é¤˜ç©åˆ† -->
      <div class="alert alert-info mb-2">
        å‰©é¤˜ç©åˆ†ï¼š<strong>{{ available_points }}</strong>
      </div>

      <!-- ä¸‹æ³¨è¡¨å–®ï¼šè¼¸å…¥ bet å¾Œè§¸ç™¼å‡å‹•ç•«å†æäº¤ -->
      <form method="POST" id="slotForm" class="mb-2">
        {% csrf_token %}
        <label for="id_bet" style="font-weight:bold;">ä¸‹æ³¨ç©åˆ†ï¼š</label>
        {{ form.bet }}
        <button type="submit" class="btn btn-danger btn-sm" id="spinBtn">æ‹‰éœ¸ï¼</button>
      </form>

      <!-- è¿”å›æœƒå“¡è³‡æ–™ -->
      <a href="{% url 'profile' %}" class="btn btn-light btn-sm mb-2">è¿”å›æœƒå“¡è³‡æ–™</a>

      <!-- è‹¥å¾Œç«¯æœ‰å‚³è¨Šæ¯ (è´åˆ†/çµæœ) -->
      {% if message %}
      <div class="alert alert-success" style="white-space: pre-wrap;">
        {{ message }}
      </div>
      {% endif %}
    </div>

    <!-- â˜… å¾Œç«¯è‹¥æœ‰æœ€çµ‚çµæœ (grid)ï¼Œå°±è—åœ¨ data-finalï¼ŒJS æœƒè®€å–ä¸¦é¡¯ç¤º -->
    {% if grid %}
      <div id="finalGrid" data-final='{{ grid|safe }}' style="display:none;"></div>
    {% else %}
      <div id="finalGrid" data-final='[]' style="display:none;"></div>
    {% endif %}
  </div>
</div>

<!-- JSï¼šå‡å‹•ç•« + é¡¯ç¤ºæœ€çµ‚çµæœ -->
<script>
document.addEventListener("DOMContentLoaded", function() {
    const spinBtn = document.getElementById("spinBtn");
    const slotForm = document.getElementById("slotForm");
    const reelsArea = document.getElementById("reelsArea");
    const finalGridDiv = document.getElementById("finalGrid");

    // â˜… è‹¥æŒ‰ã€Œæ‹‰éœ¸ï¼ã€ => å…ˆæ’­å‡å‹•ç•«å†æäº¤è¡¨å–®
    slotForm.addEventListener("submit", function(e) {
        e.preventDefault();
        spinReels(() => {
            // å‡å‹•ç•«çµæŸå¾Œå†æäº¤è¡¨å–®çµ¦å¾Œç«¯ï¼Œå¾Œç«¯è¨ˆç®—çµæœä¸¦å›å‚³
            slotForm.submit();
        });
    });

    // å‡å‹•ç•«ï¼šéš¨æ©Ÿè½‰å‹• 1.5 ç§’
    function spinReels(onFinish) {
        const symbolsPool = ["ğŸ’","ğŸ‹","ğŸ””","â­","7"];
        const startTime = Date.now();
        const duration = 1500; // 1.5ç§’
        const timer = setInterval(() => {
            const now = Date.now();
            const elapsed = now - startTime;
            if (elapsed >= duration) {
                clearInterval(timer);
                onFinish();
            } else {
                // è½‰å‹•ä¸­ï¼šé¡¯ç¤ºéš¨æ©Ÿ 3x3
                reelsArea.innerHTML = randomGridHtml(symbolsPool);
            }
        }, 100);
    }

    // ç”Ÿæˆ 3x3 éš¨æ©Ÿç¬¦è™Ÿ HTML
    function randomGridHtml(pool) {
        let html = "";
        for (let r = 0; r < 3; r++) {
            html += "<div>";
            for (let c = 0; c < 3; c++) {
                const sym = pool[Math.floor(Math.random() * pool.length)];
                html += `<span class="slot-symbol">${sym}</span>`;
            }
            html += "</div>";
        }
        return html;
    }

    // â˜… è‹¥å¾Œç«¯å·²ç”¢ç”Ÿæœ€çµ‚çµæœ => ç›´æ¥é¡¯ç¤ºå®ƒ (é é¢è¼‰å…¥å¾Œ)
    const finalData = finalGridDiv.dataset.final;
    if (finalData) {
        try {
            const grid = JSON.parse(finalData.replace(/'/g, '"'));
            if (Array.isArray(grid) && grid.length === 3) {
                // å°‡æœ€çµ‚ 3x3 çµæœé¡¯ç¤ºåœ¨ reelsArea
                let finalHtml = "";
                for (const row of grid) {
                    finalHtml += "<div>";
                    for (const sym of row) {
                        finalHtml += `<span class="slot-symbol">${sym}</span>`;
                    }
                    finalHtml += "</div>";
                }
                reelsArea.innerHTML = finalHtml;
            }
        } catch (e) {
            console.error("parse final grid error:", e);
        }
    }
});
</script>
{% endblock content %}

{% block extra_style %}
<style>
/* å¤–å±¤å®¹å™¨ç½®ä¸­ */
.slot-machine-container {
  display: flex;
  justify-content: center;
  margin-top: 1rem;
}

/* èƒŒæ™¯åœ–å®¹å™¨ */
.machine-bg {
  position: relative;
  width: 700px;   /* ä¾ç…§ slot_machine_blank.png çš„å¯¬åº¦èª¿æ•´ */
  height: 500px;  /* ä¾ç…§ slot_machine_blank.png çš„é«˜åº¦èª¿æ•´ */
}

/* èƒŒæ™¯åœ–å…¨æ»¿ */
.machine-bg-img {
  width: 100%;
  height: 100%;
  object-fit: cover; /* å¯æ”¹æˆ contain, fill ç­‰ */
}

/* ç¬¦è™Ÿé¡¯ç¤ºå€ï¼šå°æº–åœ–ç‰‡ä¸­çš„ä¸‰å€‹è½‰è»¸ */
.reels-area {
  position: absolute;
  top: 100px;   /* éœ€è‡ªè¡Œå¾®èª¿ */
  left: 120px;  /* éœ€è‡ªè¡Œå¾®èª¿ */
  width: 460px; /* 3 å€‹è½‰è»¸çš„ç¸½å¯¬åº¦ (å¯åŠ æ¸›) */
  height: 220px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
}

/* è®“æ¯ä¸€åˆ— (3 å€‹ç¬¦è™Ÿ) ç½®ä¸­ */
.reels-area div {
  text-align: center;
}

/* æ¯å€‹ç¬¦è™Ÿæ¨£å¼ */
.slot-symbol {
  font-size: 2rem;
  margin: 0 0.4rem;
}

/* æ“ä½œèˆ‡è³‡è¨Šå€ (ä¸‹æ³¨ã€ç©åˆ†ã€è¿”å›æŒ‰éˆ•ç­‰) */
.slot-controls {
  position: absolute;
  top: 350px;  /* ä¾ç…§ä½ çš„åœ–ç‰‡éœ€æ±‚å¾®èª¿ */
  left: 40px;
  width: 200px;
  background: rgba(255,255,255,0.7);
  padding: 0.5rem;
  border-radius: 6px;
}
</style>
{% endblock extra_style %}
