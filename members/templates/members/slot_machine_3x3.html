{% extends "base.html" %}
{% load static %}

{% block title %}3x3 æ‹‰éœ¸æ©Ÿ{% endblock title %}

{% block content %}
<div class="container mt-4">
  <!-- å¤–å±¤å®¹å™¨ï¼šç½®ä¸­ -->
  <div class="slot-machine-container d-flex justify-content-center">
    
    <!-- â˜… æ”¹ç”¨ .slot-machine ç•¶èƒŒæ™¯å®¹å™¨ï¼Œå…§éƒ¨ç”¨ Flex æ’ç‰ˆ -->
    <div class="slot-machine">

      <!-- æ“ä½œèˆ‡è³‡è¨Šå€ (æ”¾åœ¨ä¸Šæ–¹æˆ–ä¸‹æ–¹çš†å¯) -->
      <div class="slot-controls">
        <div class="alert alert-info mb-2">
          å‰©é¤˜ç©åˆ†ï¼š<strong>0</strong>
        </div>
        <form method="POST" id="slotForm" class="mb-2">
          {% csrf_token %}
          <label for="id_bet" style="font-weight:bold;">ä¸‹æ³¨ç©åˆ†ï¼š</label>
          <input type="number" name="bet" min="1" required id="id_bet">
          <button type="submit" class="btn btn-danger btn-sm" id="spinBtn">æ‹‰éœ¸ï¼</button>
        </form>
        <a href="/members/profile/" class="btn btn-light btn-sm mb-2">è¿”å›æœƒå“¡è³‡æ–™</a>
      </div>

      <!-- ç¬¦è™Ÿé¡¯ç¤ºå€ï¼šç”¨ #reelsArea æ”¾ã€Œå‡å‹•ç•« & æœ€çµ‚çµæœã€ -->
      <div class="reels" id="reelsArea">
        <!-- å¾Œç«¯æˆ–å‰ç«¯ JS æœƒå‹•æ…‹æ’å…¥ç¬¦è™Ÿ (3x3) -->
      </div>

      <!-- â˜… å¾Œç«¯è‹¥æœ‰æœ€çµ‚çµæœ (grid)ï¼Œå°±è—åœ¨ data-finalï¼ŒJS æœƒè®€å–ä¸¦é¡¯ç¤º -->
      <div id="finalGrid" data-final='[]' style="display:none;"></div>
    
    </div> <!-- /.slot-machine -->

  </div> <!-- /.slot-machine-container -->
</div> <!-- /.container -->

<!-- JSï¼šå‡å‹•ç•« + é¡¯ç¤ºæœ€çµ‚çµæœ -->
<script>
document.addEventListener("DOMContentLoaded", function() {
    const spinBtn = document.getElementById("spinBtn");
    const slotForm = document.getElementById("slotForm");
    const reelsArea = document.getElementById("reelsArea");
    const finalGridDiv = document.getElementById("finalGrid");

    // â˜… æŒ‰ã€Œæ‹‰éœ¸ï¼ã€ => å…ˆæ’­å‡å‹•ç•«å†æäº¤è¡¨å–®
    slotForm.addEventListener("submit", function(e) {
        e.preventDefault();
        spinReels(() => {
            // å‡å‹•ç•«çµæŸå¾Œå†æäº¤è¡¨å–®çµ¦å¾Œç«¯ï¼Œå¾Œç«¯è¨ˆç®—çµæœä¸¦å›å‚³
            slotForm.submit();
        });
    });

    // å‡å‹•ç•«ï¼šéš¨æ©Ÿè½‰å‹• 1.5 ç§’
    function spinReels(onFinish) {
        const symbolsPool = ["ğŸ’","ğŸ‹","ğŸ””","â­","7"];
        const startTime = Date.now();
        const duration = 1500; // 1.5ç§’
        const timer = setInterval(() => {
            const now = Date.now();
            const elapsed = now - startTime;
            if (elapsed >= duration) {
                clearInterval(timer);
                onFinish();
            } else {
                reelsArea.innerHTML = randomGridHtml(symbolsPool);
            }
        }, 100);
    }

    // ç”Ÿæˆ 3x3 éš¨æ©Ÿç¬¦è™Ÿ HTML
    function randomGridHtml(pool) {
        let html = "";
        for (let r = 0; r < 3; r++) {
            html += "<div>";  // æ¯è¡Œ
            for (let c = 0; c < 3; c++) {
                const sym = pool[Math.floor(Math.random() * pool.length)];
                html += `<span class="slot-symbol">${sym}</span>`;
            }
            html += "</div>";
        }
        return html;
    }

    // â˜… è‹¥å¾Œç«¯å·²ç”¢ç”Ÿæœ€çµ‚çµæœ => ç›´æ¥é¡¯ç¤ºå®ƒ (é é¢è¼‰å…¥å¾Œ)
    const finalData = finalGridDiv.dataset.final;
    if (finalData) {
        try {
            const grid = JSON.parse(finalData.replace(/'/g, '"'));
            if (Array.isArray(grid) && grid.length === 3) {
                let finalHtml = "";
                for (const row of grid) {
                    finalHtml += "<div>";
                    for (const sym of row) {
                        finalHtml += `<span class="slot-symbol">${sym}</span>`;
                    }
                    finalHtml += "</div>";
                }
                reelsArea.innerHTML = finalHtml;
            }
        } catch (e) {
            console.error("parse final grid error:", e);
        }
    }
});
</script>
{% endblock content %}

{% block extra_style %}
<style>
/* â˜… çˆ¶å®¹å™¨ (Flex ç‰ˆ) â˜… --------------------------------------- */

/* å¤–å±¤å®¹å™¨ï¼šæ‚¨å¯ä¿ç•™ Bootstrap .container + .slot-machine-container */
.slot-machine-container {
  /* å·²åœ¨ HTML ç”¨ d-flex + justify-content-center ç½®ä¸­ */
}

/* â˜… ä¸»è¦èƒŒæ™¯å®¹å™¨ï¼šç›´æ¥ä½¿ç”¨èƒŒæ™¯åœ– (ä¸ç”¨å†æ”¾ <img>) */
.slot-machine {
  width: 700px;
  height: 500px;
  background: url("/static/members/slot_machine_blank.png") no-repeat center center;
  background-size: cover;  /* å¯æ”¹æˆ contain, fill ç­‰ */
  
  /* ç”¨ Flex è®“ã€Œæ§åˆ¶å€ã€èˆ‡ã€Œç¬¦è™Ÿå€ã€è‡ªå‹•æ’ç‰ˆ */
  display: flex;
  flex-direction: column;
  align-items: center;     /* æ°´å¹³ç½®ä¸­ */
  justify-content: space-between; /* ä¸Šä¸‹åˆ†å¸ƒ */
  
  border: 1px solid #ccc;  /* é™¤éŒ¯ç”¨ï¼Œå¯ç§»é™¤ */
  position: relative;
}

/* â˜… æ“ä½œèˆ‡è³‡è¨Šå€ (slot-controls) ï¼šä¸Šæ–¹æˆ–ä¸‹æ–¹çš†å¯ */
.slot-controls {
  width: 90%;  
  background: rgba(255,255,255,0.7);
  margin-top: 1rem;
  padding: 0.5rem;
  border-radius: 6px;
  text-align: center;
}

/* â˜… ç¬¦è™Ÿé¡¯ç¤ºå€ (reels) */
.reels {
  /* è®“ 3x3 çš„ç¬¦è™Ÿå¤§æ¦‚ç½®ä¸­åœ¨èƒŒæ™¯åœ–ä¸‹åŠéƒ¨ */
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  margin-bottom: 1rem; /* è®“ä¸‹æ–¹ç•™é»ç©ºé–“ */
  
  /* è‹¥æƒ³æ§åˆ¶ç¬¦è™Ÿå€çš„é«˜åº¦ï¼Œå¯å¯«å›ºå®šå€¼æˆ–ç™¾åˆ†æ¯” */
  /* height: 50%; */
  /* border: 1px solid red; (æ¸¬è©¦ç”¨) */
}

/* æ¯ä¸€è¡Œ (div) ç½®ä¸­ */
.reels div {
  text-align: center;
  margin: 0.4rem 0; /* è¡Œé–“è· */
}

/* â˜… å–®ä¸€ç¬¦è™Ÿæ¨£å¼ */
.slot-symbol {
  font-size: 2rem;
  margin: 0 0.4rem;
}
</style>
{% endblock extra_style %}
