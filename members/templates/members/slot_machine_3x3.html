{% extends "base.html" %}
{% load static %}

{% block title %}3x3 æ‹‰éœ¸æ©Ÿ{% endblock %}

{% block content %}
<div class="slot-machine-container">
  <!-- æ©Ÿå°èƒŒæ™¯å®¹å™¨ -->
  <div class="machine-bg">
    <!-- æ‹‰éœ¸æ©ŸèƒŒæ™¯åœ– -->
    <img src="{% static 'members/slot_machine_blank.png' %}" alt="slot machine" class="machine-bg-img">

    <!-- â˜… è½‰è¼ªçµæœé¡¯ç¤ºå€ (3x3) -->
    <!--   ä½ç½®å°æº–èƒŒæ™¯åœ–ä¸‰å€‹è½‰è»¸ï¼Œä¾ä½ å¯¦éš›åœ–å¤§å°ä¾†å¾®èª¿ -->
    <div class="reels-area" id="reelsArea">
      <!-- é è¨­åœ¨ JS å‡å‹•ç•« or å¾Œç«¯æœ€çµ‚çµæœ æœƒæ›´æ–°é€™è£¡ -->
    </div>

    <!-- â˜… æ“ä½œå€ï¼šé¡¯ç¤ºå‰©é¤˜ç©åˆ†ã€ä¸‹æ³¨è¡¨å–®ã€è¿”å›æŒ‰éˆ•ã€æœ€çµ‚è¨Šæ¯ç­‰ -->
    <div class="slot-controls">
      <div class="alert alert-info mb-2">
        å‰©é¤˜ç©åˆ†ï¼š<strong>{{ available_points }}</strong>
      </div>

      <form method="POST" id="slotForm" class="mb-2">
        {% csrf_token %}
        <label for="id_bet" style="font-weight:bold;">ä¸‹æ³¨ç©åˆ†ï¼š</label>
        {{ form.bet }}
        <button type="submit" class="btn btn-danger btn-sm" id="spinBtn">æ‹‰éœ¸ï¼</button>
      </form>

      <a href="{% url 'profile' %}" class="btn btn-light btn-sm mb-2">è¿”å›æœƒå“¡è³‡æ–™</a>

      {% if message %}
      <div class="alert alert-success" style="white-space: pre-wrap;">
          {{ message }}
      </div>
      {% endif %}
    </div>

    <!-- â˜… éš±è—çš„æœ€çµ‚çµæœ (è‹¥å¾Œç«¯æœ‰æä¾› grid) -->
    {% if grid %}
      <div id="finalGrid" data-final='{{ grid|safe }}' style="display:none;"></div>
    {% else %}
      <div id="finalGrid" data-final='[]' style="display:none;"></div>
    {% endif %}
  </div>
</div>

<!-- å‡å‹•ç•« JSï¼Œä¸¦åœ¨é é¢è¼‰å…¥å¾Œè‹¥æœ‰æœ€çµ‚çµæœï¼Œå°±é¡¯ç¤ºå®ƒ -->
<script>
document.addEventListener("DOMContentLoaded", function() {
    const spinBtn = document.getElementById("spinBtn");
    const slotForm = document.getElementById("slotForm");
    const reelsArea = document.getElementById("reelsArea");
    const finalGridDiv = document.getElementById("finalGrid");

    // 1) å¦‚æœä½¿ç”¨è€…æŒ‰ä¸‹ã€Œæ‹‰éœ¸ï¼ã€ => å‡å‹•ç•«å¾Œå†æäº¤è¡¨å–®
    slotForm.addEventListener("submit", function(e) {
        e.preventDefault();
        spinReels(function() {
            slotForm.submit();
        });
    });

    // 2) å‡å‹•ç•«ï¼šè½‰ 1.5 ç§’
    function spinReels(onFinish) {
        let symbolsPool = ["ğŸ’","ğŸ‹","ğŸ””","â­","7"];
        let startTime = Date.now();
        let duration = 1500; // 1.5ç§’
        let timer = setInterval(function() {
            let now = Date.now();
            let elapsed = now - startTime;
            if (elapsed >= duration) {
                clearInterval(timer);
                onFinish();
            } else {
                reelsArea.innerHTML = randomGridHtml(symbolsPool);
            }
        }, 100);
    }

    // 3) ç”Ÿæˆéš¨æ©Ÿ 3x3 HTML
    function randomGridHtml(pool) {
        let html = "";
        for (let r = 0; r < 3; r++) {
            html += "<div>";
            for (let c = 0; c < 3; c++) {
                let sym = pool[Math.floor(Math.random() * pool.length)];
                html += `<span class="slot-symbol">${sym}</span>`;
            }
            html += "</div>";
        }
        return html;
    }

    // 4) è‹¥å¾Œç«¯å·²çµ¦æœ€çµ‚çµæœ => é¡¯ç¤ºå®ƒ
    let finalData = finalGridDiv.dataset.final;
    if (finalData) {
        try {
            let grid = JSON.parse(finalData.replace(/'/g, '"'));
            if (grid.length === 3) {
                // é¡¯ç¤ºæœ€çµ‚ 3x3
                let html = "";
                for (let row of grid) {
                    html += "<div>";
                    for (let sym of row) {
                        html += `<span class="slot-symbol">${sym}</span>`;
                    }
                    html += "</div>";
                }
                reelsArea.innerHTML = html;
            }
        } catch(e) {
            console.error("parse final grid error:", e);
        }
    }
});
</script>
{% endblock %}

{% block extra_style %}
<style>
/* 1) æ•´å€‹å®¹å™¨ç½®ä¸­ */
.slot-machine-container {
  display: flex;
  justify-content: center;
  margin-top: 1rem;
}

/* 2) æ©Ÿå°èƒŒæ™¯å€åŸŸ (å›ºå®šå¯¬é«˜, ä¾å¯¦éš›åœ–å¤§å°) */
.machine-bg {
  position: relative;
  width: 700px;  /* ä¾ä½ çš„åœ–å¯¬åº¦ */
  height: 500px; /* ä¾ä½ çš„åœ–é«˜åº¦ */
}

/* 3) èƒŒæ™¯åœ–å…¨æ»¿è©²å€åŸŸ */
.machine-bg-img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

/* 4) è½‰è¼ªé¡¯ç¤ºå€: å°æº–åœ–ä¸Šä¸‰å€‹è½‰è»¸ */
.reels-area {
  position: absolute;
  top: 100px;   /* è‡ªè¡Œå¾®èª¿ */
  left: 120px;  /* è‡ªè¡Œå¾®èª¿ */
  width: 460px; /* 3 æ ¼å¯¬åº¦(3*å¤§ç´„150px), è¦–åœ–å¤§å°èª¿æ•´ */
  height: 220px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  /* å¯åŠ å€‹åŠé€æ˜èƒŒæ™¯å¹«åŠ©å°é½Š:
     background: rgba(255,255,255,0.3);
     border: 1px solid #333;
  */
}
.reels-area div {
  text-align: center;
}
.slot-symbol {
  font-size: 2rem;
  margin: 0 0.4rem;
}

/* 5) ä¸‹æ–¹æ“æ§å€(ä¸‹æ³¨ã€ç©åˆ†ã€è¿”å›ç­‰) => çµ•å°å®šä½ */
.slot-controls {
  position: absolute;
  top: 350px;   /* ä¾å¯¦éš›éœ€æ±‚ */
  left: 50px;
  width: 200px;
  background: rgba(255,255,255,0.6);
  padding: 0.5rem;
  border-radius: 6px;
}
</style>
{% endblock extra_style %}
