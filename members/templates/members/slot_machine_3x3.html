{% extends "base.html" %}
{% load static %}

{% block title %}3x3 拉霸機{% endblock %}

{% block content %}
<div class="slot-machine-container">
  <!-- 機台背景容器 -->
  <div class="machine-bg">
    <!-- 你的拉霸機背景圖 -->
    <img src="{% static 'members/slot_machine_blank.png' %}" alt="slot machine" class="machine-bg-img">

    <!-- 轉輪結果顯示區 (3x3) -->
    <div class="reels-area" id="reelsArea">
      <!-- 這裡會顯示假動畫或後端產生的最終 3x3 結果 -->
    </div>

    <!-- 可以在下方或另行絕對定位你的「下注按鈕、剩餘積分、返回按鈕」等 -->
    <!-- 範例：顯示剩餘積分、表單 -->
    <div class="slot-controls">
      <div class="alert alert-info">
        剩餘積分：<strong>{{ available_points }}</strong>
      </div>

      <form method="POST" id="slotForm">
        {% csrf_token %}
        <label for="id_bet" style="font-weight:bold;">下注積分：</label>
        {{ form.bet }}
        <button type="submit" class="btn btn-danger btn-sm" id="spinBtn">拉霸！</button>
      </form>

      <p>
        <a href="{% url 'profile' %}" class="btn btn-light btn-sm">返回會員資料</a>
      </p>

      {% if message %}
      <div class="alert alert-success mt-2" style="white-space: pre-wrap;">
          {{ message }}
      </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- 假動畫 JS，依照你原先的寫法 -->
<script>
document.addEventListener("DOMContentLoaded", function() {
    const spinBtn = document.getElementById("spinBtn");
    const slotForm = document.getElementById("slotForm");
    const reelsArea = document.getElementById("reelsArea");

    // 假動畫：先阻止 submit -> 播動畫 -> submit
    slotForm.addEventListener("submit", function(e) {
        e.preventDefault();
        spinReels(function() {
            slotForm.submit();
        });
    });

    function spinReels(onFinish) {
        let symbolsPool = ["🍒","🍋","🔔","⭐","7"];
        let startTime = Date.now();
        let duration = 1500; // 1.5秒
        let timer = setInterval(function() {
            let now = Date.now();
            let elapsed = now - startTime;
            if (elapsed >= duration) {
                clearInterval(timer);
                onFinish();
            } else {
                reelsArea.innerHTML = randomGridHtml(symbolsPool);
            }
        }, 100);
    }

    function randomGridHtml(pool) {
        let html = "";
        for (let r = 0; r < 3; r++) {
            html += "<div>";
            for (let c = 0; c < 3; c++) {
                let sym = pool[Math.floor(Math.random() * pool.length)];
                html += `<span class="slot-symbol">${sym}</span>`;
            }
            html += "</div>";
        }
        return html;
    }
});
</script>
{% endblock content %}

{% block extra_style %}
<style>
.slot-machine-container {
  display: flex;
  justify-content: center;
  margin-top: 1rem;
}

/* 機台背景區域 */
.machine-bg {
  position: relative;
  width: 700px;  /* 依你的圖實際寬度 */
  height: 500px; /* 依你的圖實際高度 */
}

/* 背景圖全滿該區域 */
.machine-bg-img {
  width: 100%;
  height: 100%;
  object-fit: cover; /* 依喜好 */
}

/* 轉輪顯示區: 對準三個白色框的位置 */
.reels-area {
  position: absolute;
  top: 100px;    /* 依實際圖來微調 */
  left: 120px;   /* 依實際圖來微調 */
  width: 460px;  /* 3 格寬度, 自行測量 */
  height: 220px; /* 白色框的高度 */
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  /* 可加背景以測試對齊
  background: rgba(255,255,255,0.3);
  border: 1px solid #333;
  */
}
.reels-area div {
  text-align: center;
}
.slot-symbol {
  font-size: 2rem;
  margin: 0 0.4rem;
}

/* 下方操控區, 也絕對定位, 依喜好放位置 */
.slot-controls {
  position: absolute;
  top: 350px;  /* 看你想放在哪 */
  left: 50px;
  width: 200px;
  background: rgba(255,255,255,0.6);
  padding: 0.5rem;
  border-radius: 6px;
}
</style>
{% endblock extra_style %}
