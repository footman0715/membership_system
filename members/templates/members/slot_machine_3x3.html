{% extends "base.html" %}
{% block title %}3x3 æ‹‰éœ¸æ©Ÿ{% endblock %}

{% block content %}
<!-- å¤–å±¤å€å¡Šï¼šç‚«å½©æ¼¸å±¤èƒŒæ™¯ -->
<div class="slot-machine-bg">

  <!-- åŠé€æ˜å¡ç‰‡ï¼Œå®¹ç´åŸæœ‰åŠŸèƒ½ -->
  <div class="slot-machine-card">

    <!-- æ‹‰éœ¸æ©Ÿæ¨™é¡Œ (ä¿ç•™åŸæœ‰ h2ï¼Œä½†åŠ ä¸Šç‚«å½©éœ“è™¹) -->
    <h2 class="my-3 slot-machine-title">3x3 æ‹‰éœ¸æ©Ÿ</h2>

    <!-- é¡¯ç¤ºå‰©é¤˜ç©åˆ† (åŸæœ‰ alert å€å¡Š) -->
    <div class="alert alert-info">
        å‰©é¤˜ç©åˆ†ï¼š<strong>{{ available_points }}</strong>
    </div>

    <!-- å›åˆ°æœƒå“¡è³‡æ–™é  (åŸæœ‰æŒ‰éˆ•) -->
    <p>
        <a href="{% url 'profile' %}" class="btn btn-light">è¿”å›æœƒå“¡è³‡æ–™</a>
    </p>

    <!-- åŸæœ‰è¡¨å–® (åŠ ä¸Šå°è£é£¾) -->
    <form method="POST" id="slotForm" class="card p-3 mb-3" style="max-width: 400px; margin:auto;">
        {% csrf_token %}
        <div class="mb-3">
            {{ form.bet.label_tag }}
            {{ form.bet }}
            <small class="form-text text-muted">è«‹è¼¸å…¥æƒ³ä¸‹æ³¨çš„ç©åˆ†</small>
        </div>
        <button type="submit" class="btn btn-danger btn-lg" id="spinBtn">æ‹‰éœ¸ï¼</button>
    </form>

    <!-- è‹¥æœ‰ä¸­ç/æç¤ºè¨Šæ¯ (åŸæœ‰ alert-success) -->
    {% if message %}
    <div class="alert alert-success" style="white-space: pre-wrap;">
        {{ message }}
    </div>
    {% endif %}

    <!-- è½‰å‹•çµæœå€å¡Š (åŸæœ‰ slotResult) -->
    <div id="slotResult" class="my-4">
        <!-- å¾Œç«¯æœ€çµ‚çµæœ data -->
        {% if grid %}
          <div id="finalGrid" data-final='{{ grid|safe }}'></div>
        {% else %}
          <div id="finalGrid" data-final='[]'></div>
        {% endif %}
        <!-- å¯¦éš›é¡¯ç¤ºå€åŸŸ (åŸæœ‰ reelsArea) -->
        <div id="reelsArea" class="mt-3"></div>
    </div>
  </div>
</div>

<!-- ä¿ç•™åŸæœ‰ JS å‡å‹•ç•«é‚è¼¯ -->
<script>
document.addEventListener("DOMContentLoaded", function() {
    const spinBtn = document.getElementById("spinBtn");
    const slotForm = document.getElementById("slotForm");
    const reelsArea = document.getElementById("reelsArea");
    const finalGridDiv = document.getElementById("finalGrid");

    // é˜»æ­¢è¡¨å–®é è¨­æäº¤ï¼Œå…ˆæ’­æ”¾å‡å‹•ç•«
    slotForm.addEventListener("submit", function(e) {
        e.preventDefault();
        spinReels(function() {
            slotForm.submit();
        });
    });

    // å‡å‹•ç•«ï¼šè½‰å‹• 1.5 ç§’
    function spinReels(onFinish) {
        let symbolsPool = ["ğŸ’","ğŸ‹","ğŸ””","â­","7"];
        let startTime = Date.now();
        let duration = 1500; // 1.5 ç§’
        let timer = setInterval(function() {
            let now = Date.now();
            let elapsed = now - startTime;
            if (elapsed >= duration) {
                clearInterval(timer);
                onFinish();
            } else {
                reelsArea.innerHTML = randomGridHtml(symbolsPool);
            }
        }, 100);
    }

    // ç”Ÿæˆéš¨æ©Ÿ 3x3 HTML
    function randomGridHtml(pool) {
        let html = "";
        for (let r = 0; r < 3; r++) {
            html += "<div>";
            for (let c = 0; c < 3; c++) {
                let sym = pool[Math.floor(Math.random() * pool.length)];
                html += `<span style="font-size:2rem;margin-right:1em;">${sym}</span>`;
            }
            html += "</div>";
        }
        return html;
    }

    // é¡¯ç¤ºå¾Œç«¯çš„æœ€çµ‚çµæœ (è‹¥æœ‰)
    let finalData = finalGridDiv.dataset.final;
    if (finalData) {
        try {
            let grid = JSON.parse(finalData.replace(/'/g, '"'));
            let html = "";
            for (let row of grid) {
                html += "<div>";
                for (let sym of row) {
                    html += `<span style="font-size:2rem;margin-right:1em;">${sym}</span>`;
                }
                html += "</div>";
            }
            reelsArea.innerHTML = html;
        } catch(e) {
            console.error("parse final grid error:", e);
        }
    }
});
</script>
{% endblock %}

{% block extra_style %}
<style>
/* èƒŒæ™¯ï¼šVegas é¢¨æ ¼æ¼¸å±¤ + æ˜Ÿå…‰é–ƒçˆ */
.slot-machine-bg {
  position: relative;
  min-height: 100vh;
  padding: 2rem;
  background: linear-gradient(135deg, #ff6a00, #ee0979);
  overflow: hidden; /* ä½¿èƒŒæ™¯è£é£¾ä¸è¶…å‡ºå®¹å™¨ */
  display: flex;
  align-items: center;
  justify-content: center;
}

/* èƒŒæ™¯ä¸Šåšä¸€å€‹é–ƒçˆæ˜Ÿé» */
.slot-machine-bg::before {
  content: "";
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  background: radial-gradient(rgba(255,255,255,0.3) 2px, transparent 3px) repeat;
  background-size: 50px 50px;
  opacity: 0.3;
  animation: sparkle 4s linear infinite;
  pointer-events: none;
}
@keyframes sparkle {
  0% { background-position: 0 0; }
  100% { background-position: 50px 50px; }
}

/* åŠé€æ˜å¤–æ¡†å¡ç‰‡ */
.slot-machine-card {
  position: relative;
  max-width: 600px;
  width: 100%;
  background: rgba(255, 255, 255, 0.15);
  border: 2px solid rgba(255, 255, 255, 0.3);
  border-radius: 15px;
  backdrop-filter: blur(10px);
  box-shadow: 0 0 30px rgba(0,0,0,0.3);
  padding: 2rem;
  z-index: 1;
}

/* æ‹‰éœ¸æ©Ÿæ¨™é¡Œï¼šéœ“è™¹å­— */
.slot-machine-title {
  font-family: "Impact", sans-serif;
  color: #fff;
  text-shadow:
    0 0 5px rgba(255,255,255,0.8),
    0 0 10px rgba(255,255,255,0.8),
    0 0 20px #ff00de,
    0 0 30px #ff00de,
    0 0 40px #ff00de;
  text-align: center;
}
</style>
{% endblock %}
