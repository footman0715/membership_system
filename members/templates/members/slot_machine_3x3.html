{% extends "base.html" %}
{% load static %}

{% block title %}3x3 æ‹‰éœ¸æ©Ÿ{% endblock title %}

{% block content %}
<div class="slot-machine-container">
  <!-- èƒŒæ™¯å®¹å™¨ -->
  <div class="machine-bg">
    <!-- èƒŒæ™¯åœ–ï¼šè«‹ç¢ºä¿ slot_machine_blank.png å·²æ”¾åœ¨ static/members/ è£¡ -->
    <img 
      src="{% static 'members/slot_machine_blank.png' %}" 
      alt="slot machine" 
      class="machine-bg-img"
    >

    <!-- â˜… ç¬¦è™Ÿé¡¯ç¤ºå€ (3x3) -->
    <div class="reels-area" id="reelsArea">
      <!-- å¾Œç«¯ç”¢ç”Ÿçš„æœ€çµ‚çµæœï¼Œæˆ–å‡å‹•ç•«ä¸­éš¨æ©Ÿç¬¦è™Ÿï¼Œéƒ½æœƒé¡¯ç¤ºåœ¨é€™è£¡ -->
    </div>

    <!-- â˜… æ“ä½œèˆ‡è³‡è¨Šå€ -->
    <div class="slot-controls">
      <!-- é¡¯ç¤ºå‰©é¤˜ç©åˆ† -->
      <div class="alert alert-info mb-2">
        å‰©é¤˜ç©åˆ†ï¼š<strong>{{ available_points }}</strong>
      </div>

      <!-- ä¸‹æ³¨è¡¨å–®ï¼šè¼¸å…¥ bet å¾Œè§¸ç™¼å‡å‹•ç•«å†æäº¤ -->
      <form method="POST" id="slotForm" class="mb-2">
        {% csrf_token %}
        <label for="id_bet" style="font-weight:bold;">ä¸‹æ³¨ç©åˆ†ï¼š</label>
        {{ form.bet }}
        <button type="submit" class="btn btn-danger btn-sm" id="spinBtn">æ‹‰éœ¸ï¼</button>
      </form>

      <!-- è¿”å›æœƒå“¡è³‡æ–™ -->
      <a href="{% url 'profile' %}" class="btn btn-light btn-sm mb-2">è¿”å›æœƒå“¡è³‡æ–™</a>

      <!-- è‹¥å¾Œç«¯æœ‰å‚³è¨Šæ¯ (è´åˆ†/çµæœ) -->
      {% if message %}
      <div class="alert alert-success" style="white-space: pre-wrap;">
        {{ message }}
      </div>
      {% endif %}
    </div>

    <!-- â˜… å¾Œç«¯è‹¥æœ‰æœ€çµ‚çµæœ (grid)ï¼Œå°±è—åœ¨ data-finalï¼ŒJS æœƒè®€å–ä¸¦é¡¯ç¤º -->
    {% if grid %}
      <div id="finalGrid" data-final='{{ grid|safe }}' style="display:none;"></div>
    {% else %}
      <div id="finalGrid" data-final='[]' style="display:none;"></div>
    {% endif %}
  </div>
</div>

<!-- JSï¼šå‡å‹•ç•« + é¡¯ç¤ºæœ€çµ‚çµæœ -->
<script>
document.addEventListener("DOMContentLoaded", function() {
    const spinBtn = document.getElementById("spinBtn");
    const slotForm = document.getElementById("slotForm");
    const reelsArea = document.getElementById("reelsArea");
    const finalGridDiv = document.getElementById("finalGrid");

    // â˜… æŒ‰ã€Œæ‹‰éœ¸ï¼ã€ => å…ˆæ’­å‡å‹•ç•«å†æäº¤è¡¨å–®
    slotForm.addEventListener("submit", function(e) {
        e.preventDefault();
        spinReels(() => {
            slotForm.submit();
        });
    });

    // å‡å‹•ç•«ï¼šéš¨æ©Ÿè½‰å‹• 1.5 ç§’
    function spinReels(onFinish) {
        // ä½¿ç”¨è¼ƒã€Œå‚³çµ±æ‹‰éœ¸æ©Ÿã€é¢¨æ ¼çš„ç¬¦è™Ÿï¼š7ã€éˆ´éºã€æ«»æ¡ƒã€æ©™å­ã€çš‡å† ã€çç›ƒã€BAR
        // æ‚¨å¯è‡ªè¡Œå¢åˆª
        const symbolsPool = ["7","ğŸ””","ğŸ’","ğŸŠ","ğŸ‘‘","ğŸ†","BAR"];
        const startTime = Date.now();
        const duration = 1500; // 1.5ç§’
        const timer = setInterval(() => {
            const now = Date.now();
            const elapsed = now - startTime;
            if (elapsed >= duration) {
                clearInterval(timer);
                onFinish();
            } else {
                reelsArea.innerHTML = randomGridHtml(symbolsPool);
            }
        }, 100);
    }

    // ç”Ÿæˆ 3x3 éš¨æ©Ÿç¬¦è™Ÿ HTML
    function randomGridHtml(pool) {
        let html = "";
        for (let r = 0; r < 3; r++) {
            html += "<div>";
            for (let c = 0; c < 3; c++) {
                const sym = pool[Math.floor(Math.random() * pool.length)];
                // è‹¥ç¬¦è™Ÿæ˜¯ "BAR"ï¼Œå¥—ç”¨é¡å¤–æ¨£å¼ (ç™½åº• + é»‘æ¡†)
                if (sym === "BAR") {
                    html += `<span class="slot-symbol bar-symbol">BAR</span>`;
                } else {
                    html += `<span class="slot-symbol">${sym}</span>`;
                }
            }
            html += "</div>";
        }
        return html;
    }

    // â˜… è‹¥å¾Œç«¯å·²ç”¢ç”Ÿæœ€çµ‚çµæœ => ç›´æ¥é¡¯ç¤ºå®ƒ (é é¢è¼‰å…¥å¾Œ)
    const finalData = finalGridDiv.dataset.final;
    if (finalData) {
        try {
            const grid = JSON.parse(finalData.replace(/'/g, '"'));
            if (Array.isArray(grid) && grid.length === 3) {
                let finalHtml = "";
                for (const row of grid) {
                    finalHtml += "<div>";
                    for (const sym of row) {
                        if (sym === "BAR") {
                            finalHtml += `<span class="slot-symbol bar-symbol">BAR</span>`;
                        } else {
                            finalHtml += `<span class="slot-symbol">${sym}</span>`;
                        }
                    }
                    finalHtml += "</div>";
                }
                reelsArea.innerHTML = finalHtml;
            }
        } catch (e) {
            console.error("parse final grid error:", e);
        }
    }
});
</script>
{% endblock content %}

{% block extra_style %}
<style>
/* å¤–å±¤å®¹å™¨ç½®ä¸­ */
.slot-machine-container {
  display: flex;
  justify-content: center;
  margin-top: 1rem;
}

/* èƒŒæ™¯åœ–å®¹å™¨ */
.machine-bg {
  position: relative;
  width: 700px;   /* ä¾ç…§ slot_machine_blank.png çš„å¯¦éš›å¯¬åº¦ */
  height: 500px;  /* ä¾ç…§ slot_machine_blank.png çš„å¯¦éš›é«˜åº¦ */
}

/* èƒŒæ™¯åœ–ä¸è£åˆ‡ï¼Œç¶­æŒ 700x500 */
.machine-bg-img {
  width: 700px;
  height: 500px;
  object-fit: none; /* ç¢ºä¿ä¸è¢« cover */
}

/* ç¬¦è™Ÿé¡¯ç¤ºå€ï¼šå°æº–åœ–ç‰‡ä¸­çš„ä¸‰å€‹è½‰è»¸ */
.reels-area {
  position: absolute;
  top: 100px;   /* è‹¥ä¸åœ¨æ­£ä¸­é–“ï¼Œè«‹è‡ªè¡Œå¾®èª¿ */
  left: 120px;  /* è‹¥ä¸åœ¨æ­£ä¸­é–“ï¼Œè«‹è‡ªè¡Œå¾®èª¿ */
  width: 460px; /* è‹¥å¯¬åº¦ä¸è¶³æˆ–éå¤§ï¼Œè«‹è‡ªè¡Œå¾®èª¿ */
  height: 220px;
  z-index: 999;

  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;

  /* è‹¥è¦æ¸¬è©¦ä½ç½®ï¼Œå¯æš«æ™‚é–‹å•Ÿç´…æ¡†
     border: 2px solid red; */
}

/* è®“æ¯ä¸€åˆ— (3 å€‹ç¬¦è™Ÿ) ç½®ä¸­ */
.reels-area div {
  text-align: center;
}

/* ä¸€èˆ¬ç¬¦è™Ÿæ¨£å¼ï¼šåŠ å¤§å­—é«”ï¼Œè®“å®ƒæ›´åƒæ‹‰éœ¸åœ–ç¤º */
.slot-symbol {
  display: inline-block;
  font-size: 3rem;   /* èª¿æ•´å­—é«”å¤§å°ï¼Œæ‚¨å¯æ”¹æˆ 4rem, 5rem... */
  margin: 0 0.6rem;  /* æ§åˆ¶å·¦å³é–“è· */
}

/* é‡å° "BAR" åšç‰¹åˆ¥å¤–è§€ (ç™½åº• + é»‘æ¡† + ç²—é«”) */
.bar-symbol {
  font-family: "Impact", sans-serif;
  color: #000;
  background-color: #fff;
  padding: 0 8px;
  border: 2px solid #000;
  border-radius: 4px;
}

/* æ“ä½œèˆ‡è³‡è¨Šå€ (ä¸‹æ³¨ã€ç©åˆ†ã€è¿”å›æŒ‰éˆ•ç­‰) */
.slot-controls {
  position: absolute;
  top: 350px;  /* è‹¥è¦ä¸Šç§»æˆ–ä¸‹ç§»å¯è‡ªè¡Œèª¿æ•´ */
  left: 40px;
  width: 200px;
  background: rgba(255,255,255,0.7);
  padding: 0.5rem;
  border-radius: 6px;
}
</style>
{% endblock extra_style %}
