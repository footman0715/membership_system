{% extends "base.html" %}
{% block title %}3x3 æ‹‰éœ¸æ©Ÿ{% endblock %}

{% block content %}
<h2>3x3 æ‹‰éœ¸æ©Ÿ</h2>

<form method="POST" id="slotForm">
    {% csrf_token %}
    {{ form.as_p }}
    <button type="submit" class="btn btn-primary" id="spinBtn">æ‹‰éœ¸ï¼</button>
</form>

{% if message %}
<pre>{{ message }}</pre>
{% endif %}

<div id="slotResult" style="margin-top: 1em;">
  <!-- å¾Œç«¯çµ¦çš„æœ€çµ‚çµæœ -->
  {% if grid %}
    <div id="finalGrid" data-final='{{ grid|safe }}'></div>
  {% else %}
    <div id="finalGrid" data-final='[]'></div>
  {% endif %}
  <!-- çœŸæ­£é¡¯ç¤ºçš„å€åŸŸ -->
  <div id="reelsArea"></div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const spinBtn = document.getElementById("spinBtn");
    const slotForm = document.getElementById("slotForm");
    const reelsArea = document.getElementById("reelsArea");
    const finalGridDiv = document.getElementById("finalGrid");

    slotForm.addEventListener("submit", function(e) {
        // é˜»æ­¢è¡¨å–®é è¨­æäº¤
        e.preventDefault();

        // å…ˆæ’­æ”¾å‡å‹•ç•«
        spinReels(function() {
            // å‹•ç•«çµæŸå¾Œï¼Œå†çœŸæ­£æäº¤è¡¨å–®
            slotForm.submit();
        });
    });

    function spinReels(onFinish) {
        let symbolsPool = ["ğŸ’","ğŸ‹","ğŸ””","â­","7"];
        let startTime = Date.now();
        let duration = 1500; // 1.5 ç§’
        let timer = setInterval(function() {
            let now = Date.now();
            let elapsed = now - startTime;
            if (elapsed >= duration) {
                clearInterval(timer);
                onFinish();
            } else {
                reelsArea.innerHTML = randomGridHtml(symbolsPool);
            }
        }, 100);
    }

    function randomGridHtml(pool) {
        let html = "";
        for (let r = 0; r < 3; r++) {
            html += "<div>";
            for (let c = 0; c < 3; c++) {
                let sym = pool[Math.floor(Math.random()*pool.length)];
                html += `<span style="font-size:2rem;margin-right:1em;">${sym}</span>`;
            }
            html += "</div>";
        }
        return html;
    }

    // é¡¯ç¤ºå¾Œç«¯æœ€çµ‚çµæœï¼ˆè‹¥æœ‰ï¼‰
    let finalData = finalGridDiv.dataset.final;
    if (finalData) {
        try {
            let grid = JSON.parse(finalData.replace(/'/g, '"'));
            let html = "";
            for (let row of grid) {
                html += "<div>";
                for (let sym of row) {
                    html += `<span style="font-size:2rem;margin-right:1em;">${sym}</span>`;
                }
                html += "</div>";
            }
            reelsArea.innerHTML = html;
        } catch(e) {
            console.error("parse final grid error:", e);
        }
    }
});
</script>
{% endblock %}
